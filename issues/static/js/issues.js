// Generated by CoffeeScript 1.6.3
(function() {
  var AppRouter, Comment, CommentCollection, CommentListItemView, CommentListView, InlineLabelListItemView, Issue, IssueCollection, IssueListItemView, IssueListView, IssueView, Label, LabelCollection, NewIssuePanel, Panel, app, bestContrastingColour, hex2rgb, lumdiff, _ref, _ref1, _ref10, _ref11, _ref12, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7, _ref8, _ref9,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  Backbone.CollectionView = (function(_super) {
    __extends(CollectionView, _super);

    CollectionView.prototype.tagName = 'ol';

    function CollectionView(options) {
      this.children = {};
      if (options.childView != null) {
        this.childView = options.childView;
      }
      if (this.childView == null) {
        console.error('childView option is missing');
      }
      CollectionView.__super__.constructor.call(this, options);
    }

    CollectionView.prototype.initialize = function() {
      this.listenTo(this.model, 'add', this.addChildView);
      return this.listenTo(this.model, 'remove', this.removeChildModel);
    };

    CollectionView.prototype.appendChildView = function(el) {
      return this.$el.append(el);
    };

    CollectionView.prototype.addChildView = function(childModel) {
      var view;
      view = new this.childView({
        model: childModel
      });
      view.render();
      this.children[childModel.cid] = view;
      return this.appendChildView(view.el);
    };

    CollectionView.prototype.removeChildModel = function(childModel) {
      if (this.children[childModel.cid] == null) {
        return false;
      }
      this.children[childModel.cid].remove();
      return delete this.children[childModel.cid];
    };

    CollectionView.prototype.render = function() {
      var model, _i, _len, _ref, _results;
      this.clear();
      _ref = this.model.models;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        model = _ref[_i];
        if (this.children[model.cid] == null) {
          _results.push(this.addChildView(model));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    CollectionView.prototype.remove = function() {
      this.clear();
      return CollectionView.__super__.remove.call(this);
    };

    CollectionView.prototype.clear = function() {
      var child, cid, _ref;
      _ref = this.children;
      for (cid in _ref) {
        child = _ref[cid];
        child.remove();
      }
      return this.children = {};
    };

    return CollectionView;

  })(Backbone.View);

  Backbone.Subset = (function(_super) {
    __extends(Subset, _super);

    function Subset(options) {
      if (!options.superset instanceof Backbone.Collection) {
        throw 'options.superset has to be an instance of Backbone.Collection';
      }
      if (options.filter == null) {
        throw 'options.filter has to be a function';
      }
      this.superset = options.superset, this.filter = options.filter;
      this.model = options.model || this.superset.model;
      Subset.__super__.constructor.call(this, [], options);
      this.superset.on('add', this.filterAdd, this);
      this.superset.on('remove', this.filterRemove, this);
      this.superset.on('change', this.filterChange, this);
      this.on('change', this.filterChange, this);
    }

    Subset.prototype.sync = function(action, model, options) {
      if (action === 'read' && (this.url != null)) {
        return Subset.__super__.sync.call(this, action, model, options);
      } else {
        return this.superset.sync(action, this.superset, options);
      }
    };

    Subset.prototype.filterAdd = function(model) {
      if (this.filter(model)) {
        return Subset.__super__.add.call(this, model);
      }
    };

    Subset.prototype.filterRemove = function(model) {
      return Subset.__super__.remove.call(this, model);
    };

    Subset.prototype.filterChange = function(model) {
      if (this.filter(model)) {
        return Subset.__super__.add.call(this, model);
      } else {
        return Subset.__super__.remove.call(this, model);
      }
    };

    Subset.prototype.add = function(models, options) {
      return this.superset.add(models, options);
    };

    Subset.prototype.remove = function(models, options) {
      return this.superset.remove(models, options);
    };

    return Subset;

  })(Backbone.Collection);

  hex2rgb = function(hex) {
    var colour;
    if (hex.charAt(0 === '#')) {
      hex = hex.substring(1, 7);
    }
    return colour = {
      r: parseInt(hex.substring(0, 2), 16),
      g: parseInt(hex.substring(2, 4), 16),
      b: parseInt(hex.substring(4, 6), 16)
    };
  };

  lumdiff = function(c1, c2) {
    var l1, l2;
    l1 = (0.2126 * Math.pow(c1.r / 255, 2.2)) + (0.7152 * Math.pow(c1.g / 255, 2.2)) + (0.0722 * Math.pow(c1.b / 255, 2.2));
    l2 = (0.2126 * Math.pow(c2.r / 255, 2.2)) + (0.7152 * Math.pow(c2.g / 255, 2.2)) + (0.0722 * Math.pow(c2.b / 255, 2.2));
    if (l1 > l2) {
      return (l1 + 0.05) / (l2 + 0.05);
    } else {
      return (l2 + 0.05) / (l1 + 0.05);
    }
  };

  bestContrastingColour = function(hex) {
    var bc, black, wc, white;
    black = '#000000';
    white = '#ffffff';
    bc = lumdiff(hex2rgb(black), hex2rgb(hex));
    wc = lumdiff(hex2rgb(white), hex2rgb(hex));
    if (bc > wc) {
      return black;
    } else {
      return white;
    }
  };

  Issue = (function(_super) {
    __extends(Issue, _super);

    function Issue() {
      _ref = Issue.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    Issue.prototype.defaults = {
      id: null,
      title: '',
      description: '',
      labels: []
    };

    Issue.prototype.urlRoot = '/api/issues';

    Issue.prototype.initialize = function() {
      var _this = this;
      this.comments = new CommentCollection([], {
        url: function() {
          return "" + (_this.url()) + "/comments";
        }
      });
      return this.labels = new LabelCollection(this.get('labels'), {
        url: function() {
          return "" + (_this.url()) + "/labels";
        }
      });
    };

    return Issue;

  })(Backbone.Model);

  IssueCollection = (function(_super) {
    __extends(IssueCollection, _super);

    function IssueCollection() {
      _ref1 = IssueCollection.__super__.constructor.apply(this, arguments);
      return _ref1;
    }

    IssueCollection.prototype.model = Issue;

    return IssueCollection;

  })(Backbone.Collection);

  Comment = (function(_super) {
    __extends(Comment, _super);

    function Comment() {
      _ref2 = Comment.__super__.constructor.apply(this, arguments);
      return _ref2;
    }

    Comment.prototype.validate = function(attr, options) {
      if ((jQuery.trim(attr.text)) === '') {
        return 'The comment has no text';
      }
    };

    return Comment;

  })(Backbone.Model);

  CommentCollection = (function(_super) {
    __extends(CommentCollection, _super);

    function CommentCollection() {
      _ref3 = CommentCollection.__super__.constructor.apply(this, arguments);
      return _ref3;
    }

    CommentCollection.prototype.model = Comment;

    return CommentCollection;

  })(Backbone.Collection);

  Label = (function(_super) {
    __extends(Label, _super);

    function Label() {
      _ref4 = Label.__super__.constructor.apply(this, arguments);
      return _ref4;
    }

    Label.prototype.defaults = {
      id: null,
      name: '',
      colour: 'grey'
    };

    Label.prototype.urlRoot = '/api/labels';

    return Label;

  })(Backbone.Model);

  LabelCollection = (function(_super) {
    __extends(LabelCollection, _super);

    function LabelCollection() {
      _ref5 = LabelCollection.__super__.constructor.apply(this, arguments);
      return _ref5;
    }

    LabelCollection.prototype.model = Label;

    return LabelCollection;

  })(Backbone.Collection);

  IssueListItemView = (function(_super) {
    __extends(IssueListItemView, _super);

    function IssueListItemView() {
      _ref6 = IssueListItemView.__super__.constructor.apply(this, arguments);
      return _ref6;
    }

    IssueListItemView.prototype.template = jQuery('#tpl-issue-list-item').detach();

    IssueListItemView.prototype.initialize = function() {
      this.setElement(this.template.clone().get(0));
      this.listenTo(this.model, 'change', this.render);
      return this.labelView = new Backbone.CollectionView({
        childView: InlineLabelListItemView,
        model: this.model.labels,
        el: this.$('.issue-labels')
      });
    };

    IssueListItemView.prototype.render = function(eventName) {
      this.$('.issue-link').attr('href', "/issues/" + (this.model.get('id')));
      this.$('.issue-title').text(this.model.get('title'));
      this.$('.issue-description').text(this.model.strip('description'));
      this.$el.toggleClass('issue-completed', !!this.model.get('completed'));
      return this.labelView.render();
    };

    IssueListItemView.prototype.isSelected = function() {
      return this.$('input[type=checkbox]').get(0).checked;
    };

    return IssueListItemView;

  })(Backbone.View);

  IssueListView = (function(_super) {
    __extends(IssueListView, _super);

    function IssueListView() {
      _ref7 = IssueListView.__super__.constructor.apply(this, arguments);
      return _ref7;
    }

    IssueListView.prototype.childView = IssueListItemView;

    IssueListView.prototype.template = jQuery('#tpl-issue-list-panel').detach();

    IssueListView.prototype.events = {
      'click .close-issues-button': function(evt) {
        var child, cid, _ref8, _results;
        evt.preventDefault();
        _ref8 = this.children;
        _results = [];
        for (cid in _ref8) {
          child = _ref8[cid];
          if (child.isSelected()) {
            _results.push(child.model.save({
              completed: true
            }, {
              patch: true
            }));
          } else {
            _results.push(void 0);
          }
        }
        return _results;
      }
    };

    IssueListView.prototype.initialize = function() {
      IssueListView.__super__.initialize.call(this);
      return this.setElement(this.template.clone().get(0));
    };

    IssueListView.prototype.appendChildView = function(el) {
      return this.$('.issue-list').append(el);
    };

    return IssueListView;

  })(Backbone.CollectionView);

  IssueView = (function(_super) {
    __extends(IssueView, _super);

    function IssueView() {
      _ref8 = IssueView.__super__.constructor.apply(this, arguments);
      return _ref8;
    }

    IssueView.prototype.template = jQuery('#tpl-issue-details-panel').detach();

    IssueView.prototype.events = {
      'submit .comments form': function(evt) {
        evt.preventDefault();
        return this.addComment();
      },
      'keypress textarea': function(evt) {
        if (evt.keyCode === 13 && evt.ctrlKey) {
          evt.preventDefault();
          return this.addComment();
        }
      },
      'click .close-issue-button': function(evt) {
        evt.preventDefault();
        return this.model.save({
          'completed': true
        }, {
          patch: true
        });
      },
      'click .reopen-issue-button': function(evt) {
        evt.preventDefault();
        return this.model.save({
          'completed': false
        }, {
          patch: true
        });
      },
      'click .edit-issue-button': function(evt) {
        evt.preventDefault();
        return this.$el.addClass('editable');
      },
      'submit .edit-issue': function(evt) {
        evt.preventDefault();
        this.model.save(this.$('.edit-issue').serializeObject(), {
          patch: true
        });
        return this.$el.removeClass('editable');
      }
    };

    IssueView.prototype.initialize = function() {
      console.assert(this.model != null, 'IssueView has no model');
      this.setElement(this.template.clone().get(0));
      this.listenTo(this.model, 'change', this.render);
      this.commentListView = new CommentListView({
        model: this.model.comments,
        el: this.$('.comment-list')
      });
      return this.model.comments.fetch();
    };

    IssueView.prototype.render = function(eventName) {
      this.$('.read-issue .issue-title').text(this.model.get('title'));
      this.$('.read-issue .issue-description').html(this.model.get('description'));
      this.$('.edit-issue .issue-title').val(this.model.get('title'));
      this.$('.edit-issue .issue-description').val(this.model.get('description'));
      this.$el.toggleClass('loading', !this.model.get('added'));
      this.$el.toggleClass('issue-completed', !!this.model.get('completed'));
      return this.commentListView.render();
    };

    IssueView.prototype.addComment = function() {
      var data, options;
      data = {
        issue_id: this.model.get('id'),
        user: app.user,
        text: this.$('.comments form textarea[name=text]').val()
      };
      options = {
        validate: true
      };
      if (this.model.comments.create(data, options)) {
        return this.$('.comments form').get(0).reset();
      }
    };

    IssueView.prototype.remove = function() {
      this.commentListView.remove();
      return IssueView.__super__.remove.call(this);
    };

    return IssueView;

  })(Backbone.View);

  CommentListItemView = (function(_super) {
    __extends(CommentListItemView, _super);

    function CommentListItemView() {
      _ref9 = CommentListItemView.__super__.constructor.apply(this, arguments);
      return _ref9;
    }

    CommentListItemView.prototype.tagName = 'li';

    CommentListItemView.prototype.template = _.template(jQuery('#tpl-comment-list-item').text());

    CommentListItemView.prototype.initialize = function() {
      return this.listenTo(this.model, 'change', this.render);
    };

    CommentListItemView.prototype.render = function(eventName) {
      return this.$el.html(this.template(this.model.toJSON()));
    };

    return CommentListItemView;

  })(Backbone.View);

  CommentListView = (function(_super) {
    __extends(CommentListView, _super);

    function CommentListView() {
      _ref10 = CommentListView.__super__.constructor.apply(this, arguments);
      return _ref10;
    }

    CommentListView.prototype.childView = CommentListItemView;

    return CommentListView;

  })(Backbone.CollectionView);

  InlineLabelListItemView = (function(_super) {
    __extends(InlineLabelListItemView, _super);

    function InlineLabelListItemView() {
      _ref11 = InlineLabelListItemView.__super__.constructor.apply(this, arguments);
      return _ref11;
    }

    InlineLabelListItemView.prototype.tagName = 'span';

    InlineLabelListItemView.prototype.initialize = function() {
      return this.listenTo(this.model, 'change', this.render);
    };

    InlineLabelListItemView.prototype.render = function() {
      this.$el.css({
        'color': bestContrastingColour(this.model.get('colour')),
        'background-color': this.model.get('colour')
      });
      return this.$el.text(this.model.get('name'));
    };

    return InlineLabelListItemView;

  })(Backbone.View);

  app = null;

  jQuery.fn.serializeObject = function() {
    var data;
    data = {};
    jQuery(jQuery(this).serializeArray()).each(function(i, pair) {
      return data[pair.name] = pair.value;
    });
    return data;
  };

  Backbone.Model.prototype.strip = function(attribute) {
    return jQuery("<p>" + (this.get(attribute)) + "</p>").wrap('p').text();
  };

  Panel = (function() {
    function Panel(el) {
      this.$el = jQuery(el);
    }

    Panel.prototype.render = function(view) {
      if ((this.view != null) && this.view !== view) {
        this.view.remove();
      }
      this.view = view;
      this.view.render();
      return this.view.$el.appendTo(this.$el);
    };

    Panel.prototype.show = function() {
      return this.$el.show();
    };

    Panel.prototype.hide = function() {
      return this.$el.hide();
    };

    return Panel;

  })();

  NewIssuePanel = (function(_super) {
    __extends(NewIssuePanel, _super);

    function NewIssuePanel(el, model) {
      var _this = this;
      this.model = model;
      NewIssuePanel.__super__.constructor.call(this, el);
      this.$el.on('submit', 'form', function(evt) {
        var data, issue, options;
        evt.preventDefault();
        data = jQuery(evt.target).serializeObject();
        options = {
          success: function(issue) {
            return app.navigate("/issues/" + (issue.get('id')), true);
          }
        };
        issue = new Issue;
        if (issue.save(data, options)) {
          _this.model.add(issue);
          return evt.target.reset();
        }
      });
    }

    return NewIssuePanel;

  })(Panel);

  AppRouter = (function(_super) {
    __extends(AppRouter, _super);

    function AppRouter() {
      _ref12 = AppRouter.__super__.constructor.apply(this, arguments);
      return _ref12;
    }

    AppRouter.prototype.initialize = function(config) {
      this.route('', function() {
        return this.navigate('/todo', true);
      });
      this.route(/^issues\/new$/, 'newIssue');
      this.route(/^issues\/(\d+)$/, 'showIssue');
      this.route(/^labels\/([a-zA-Z0-9-]+)$/, 'showLabel');
      this.route(/^todo$/, 'listTodoIssues');
      this.route(/^archive$/, 'listAllIssues');
      this.user = config.user;
      this.issueCollection = new IssueCollection(config.issues);
      this.issueCollection.url = '/api/issues';
      this.todoCollection = new Backbone.Subset({
        superset: this.issueCollection,
        url: '/api/issues/todo',
        filter: function(issue) {
          return !issue.get('completed');
        }
      });
      this.panels = {
        newIssue: new NewIssuePanel('#new-issue-panel', this.issueCollection),
        showIssue: new Panel('#issue-details-panel'),
        listIssues: new Panel('#issue-list-panel')
      };
      return this.showPanel(null);
    };

    AppRouter.prototype.listTodoIssues = function() {
      var view;
      view = new IssueListView({
        model: this.todoCollection
      });
      this.todoCollection.fetch();
      return this.showPanel('listIssues', view);
    };

    AppRouter.prototype.listAllIssues = function() {
      var view;
      view = new IssueListView({
        model: this.issueCollection
      });
      this.issueCollection.fetch();
      return this.showPanel('listIssues', view);
    };

    AppRouter.prototype.newIssue = function() {
      return this.showPanel('newIssue');
    };

    AppRouter.prototype.showIssue = function(id) {
      var issue, view;
      issue = this.issueCollection.get(id);
      if (!issue) {
        issue = new Issue({
          id: id
        });
        issue.fetch();
      }
      view = new IssueView({
        model: issue
      });
      return this.showPanel('showIssue', view);
    };

    AppRouter.prototype.showPanel = function(id, view) {
      var name, panel, _ref13, _results;
      _ref13 = this.panels;
      _results = [];
      for (name in _ref13) {
        panel = _ref13[name];
        if (name === id) {
          if (view != null) {
            panel.render(view);
          }
          _results.push(panel.show());
        } else {
          _results.push(panel.hide());
        }
      }
      return _results;
    };

    return AppRouter;

  })(Backbone.Router);

  window.init = function(data) {
    app = new AppRouter({
      user: data.user,
      issues: data.issues
    });
    jQuery('#new-issue-panel').hide();
    jQuery('#issue-details-panel').hide();
    Backbone.history.start({
      pushState: true
    });
    jQuery(document.body).on('click', 'a', function(evt) {
      if (jQuery(this).data('external')) {
        return;
      }
      evt.preventDefault();
      return app.navigate((jQuery(this)).attr('href'), true);
    });
    return app;
  };

}).call(this);
